generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  // URL removed for Prisma 7; provide in prisma.config.ts
}

model User {
  id            Int       @id @default(autoincrement())
  email         String    @unique
  passwordHash  String
  fullName      String
  phone         String?
  role          UserRole  @default(STUDENT)
  institution   String?
  avatarUrl     String?
  isPremium     Boolean   @default(false)
  premiumUntil  DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  studentProfile   StudentProfile?
  examAttempts     ExamAttempt[]
  createdQuestions Question[]     @relation("QuestionCreator")
  createdExams     Exam[]         @relation("ExamCreator")
  userProgress     UserProgress[] // fixed relation

  @@map("users")
}

model StudentProfile {
  id                 Int       @id @default(autoincrement())
  userId             Int       @unique
  targetCadre        String?
  preparationYear    Int?
  lastBcsAttempt     Int?
  dailyGoalMinutes   Int       @default(120)
  createdAt          DateTime  @default(now())

  user               User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userProgress       UserProgress[]

  @@map("student_profiles")
}

model UserProgress {
  id           Int      @id @default(autoincrement())
  userId       Int
  studentProfileId Int?   // optional link if needed
  topicId      Int
  progress     Int      @default(0)
  updatedAt    DateTime @updatedAt

  user         User          @relation(fields: [userId], references: [id])
  studentProfile StudentProfile? @relation(fields: [studentProfileId], references: [id])
  topic        Topic         @relation(fields: [topicId], references: [id])

  @@map("user_progress")
}

model Subject {
  id          Int      @id @default(autoincrement())
  name        String
  nameBn      String?  
  description String?
  iconUrl     String?
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)

  topics      Topic[]
  exams       Exam[]
  
  @@map("subjects")
}

model Topic {
  id             Int          @id @default(autoincrement())
  name           String
  nameBn         String?
  description    String?
  difficultyLevel Difficulty  @default(MEDIUM)
  subjectId      Int

  subject        Subject      @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  questions      Question[]
  userProgress   UserProgress[]

  @@map("topics")
}

model Question {
  id              Int             @id @default(autoincrement())
  questionText    String
  questionTextBn  String?
  questionType    QuestionType    @default(SINGLE)
  explanation     String?
  explanationBn   String?
  bcsYear         Int?
  bcsCadre        String?
  difficulty      Difficulty      @default(MEDIUM)
  timeRequired    Int             @default(60)
  marks           Int             @default(1)
  isActive        Boolean         @default(true)

  // Relations
  topicId         Int
  topic           Topic           @relation(fields: [topicId], references: [id])
  options         QuestionOption[]
  images          QuestionImage[]
  examQuestions   ExamQuestion[]
  examResponses   ExamResponse[]
  createdById     Int
  createdBy       User            @relation("QuestionCreator", fields: [createdById], references: [id])

  createdAt       DateTime        @default(now())

  @@map("questions")
}

model QuestionOption {
  id           Int      @id @default(autoincrement())
  optionText   String
  optionTextBn String?
  optionOrder  Int      @default(0)
  isCorrect    Boolean  @default(false)
  questionId   Int

  question     Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@map("question_options")
}

model QuestionImage {
  id          Int      @id @default(autoincrement())
  questionId  Int
  imageUrl    String
  description String?

  question    Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@map("question_images")
}

model Exam {
  id                Int             @id @default(autoincrement())
  title             String
  titleBn           String?
  description       String?
  totalQuestions    Int             @default(100)
  totalMarks        Int             @default(100)
  durationMinutes   Int             @default(120)
  passingMarks      Int             @default(50)
  isFullModelTest   Boolean         @default(false)
  isTimeBound       Boolean         @default(true)
  shuffleQuestions  Boolean         @default(true)
  shuffleOptions    Boolean         @default(true)
  isActive          Boolean         @default(true)

  // Relations
  subjectId         Int?
  subject           Subject?        @relation(fields: [subjectId], references: [id])
  examQuestions     ExamQuestion[]
  examAttempts      ExamAttempt[]
  createdById       Int
  createdBy         User            @relation("ExamCreator", fields: [createdById], references: [id])

  createdAt         DateTime        @default(now())

  @@map("exams")
}

model ExamQuestion {
  id         Int      @id @default(autoincrement())
  examId     Int
  questionId Int
  order      Int      @default(0)

  exam       Exam     @relation(fields: [examId], references: [id], onDelete: Cascade)
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@unique([examId, questionId])
  @@map("exam_questions")
}

model ExamAttempt {
  id                 Int           @id @default(autoincrement())
  startedAt          DateTime      @default(now())
  completedAt        DateTime?
  timeSpentSeconds   Int           @default(0)
  totalQuestions     Int           @default(0)
  questionsAttempted Int           @default(0)
  correctAnswers     Int           @default(0)
  marksObtained      Float         @default(0)
  percentage         Float         @default(0)
  isPassed           Boolean       @default(false)
  attemptData        Json?         // Store entire attempt for review

  // Relations
  userId             Int
  user               User          @relation(fields: [userId], references: [id])
  examId             Int
  exam               Exam          @relation(fields: [examId], references: [id])
  examResponses      ExamResponse[]

  @@map("exam_attempts")
}

model ExamResponse {
  id            Int          @id @default(autoincrement())
  examAttemptId Int
  questionId    Int
  selectedOptionIds Int[]      // selected option IDs
  isCorrect     Boolean?
  answeredAt    DateTime      @default(now())

  examAttempt   ExamAttempt   @relation(fields: [examAttemptId], references: [id], onDelete: Cascade)
  question      Question      @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@map("exam_responses")
}

// Enums
enum UserRole {
  STUDENT
  ADMIN
  SUPER_ADMIN
}

enum QuestionType {
  SINGLE
  MULTIPLE
}

enum Difficulty {
  EASY
  MEDIUM
  HARD
}
